{% extends 'portal/portal_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Phê duyệt - Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-tasks mr-2"></i>Phê duyệt
                <span class="badge badge-warning">Manager</span>
            </h2>
            <p class="text-muted">Quản lý và phê duyệt các yêu cầu từ nhân viên trong team</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="info-box bg-warning">
                <span class="info-box-icon"><i class="fas fa-calendar-alt"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Đơn nghỉ phép chờ</span>
                    <span class="info-box-number">{{ stats.pending_leaves }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box bg-info">
                <span class="info-box-icon"><i class="fas fa-receipt"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Chi phí chờ duyệt</span>
                    <span class="info-box-number">{{ stats.pending_expenses }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box bg-success">
                <span class="info-box-icon"><i class="fas fa-users"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Nhân viên trong team</span>
                    <span class="info-box-number">{{ stats.team_members }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box bg-danger">
                <span class="info-box-icon"><i class="fas fa-exclamation-triangle"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Cần xử lý</span>
                    <span class="info-box-number">{{ stats.total_pending }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-rocket mr-2"></i>Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{% url 'portal_team_leaves' %}" class="btn btn-lg btn-outline-primary btn-block">
                                <i class="fas fa-calendar-check fa-2x d-block mb-2"></i>
                                <strong>Phê duyệt nghỉ phép</strong>
                                <br><small>{{ stats.pending_leaves }} đơn chờ xử lý</small>
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{% url 'portal_team_expenses' %}" class="btn btn-lg btn-outline-info btn-block">
                                <i class="fas fa-file-invoice-dollar fa-2x d-block mb-2"></i>
                                <strong>Phê duyệt chi phí</strong>
                                <br><small>{{ stats.pending_expenses }} đơn chờ xử lý</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Pending Leaves -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning">
                    <h3 class="card-title"><i class="fas fa-calendar-alt mr-2"></i>Đơn nghỉ phép chờ duyệt</h3>
                    <div class="card-tools">
                        <a href="{% url 'portal_team_leaves' %}" class="btn btn-sm btn-light">Xem tất cả</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if pending_leaves %}
                        <table class="table table-sm">
                            <tbody>
                                {% for leave in pending_leaves %}
                                <tr>
                                    <td style="width: 40px;">
                                        {% if leave.employee.avatar %}
                                            <img src="{{ leave.employee.avatar.url }}" 
                                                 class="img-circle" 
                                                 style="width: 35px; height: 35px; object-fit: cover;">
                                        {% else %}
                                            <div class="img-circle bg-info d-flex align-items-center justify-content-center" 
                                                 style="width: 35px; height: 35px;">
                                                <strong>{{ leave.employee.full_name|slice:":1" }}</strong>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ leave.employee.name }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ leave.start_date|date:"d/m" }} - {{ leave.end_date|date:"d/m" }}
                                            ({{ leave.total_days }} ngày)
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge badge-info">
                                            {{ leave.leave_type.name }}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <button type="button" class="btn btn-xs btn-success" 
                                                onclick="approveLeave({{ leave.id }})"
                                                title="Duyệt">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-xs btn-danger" 
                                                onclick="rejectLeave({{ leave.id }})"
                                                title="Từ chối">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="p-3 text-center text-muted">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <p>Không có đơn nghỉ phép chờ duyệt</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pending Expenses -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info">
                    <h3 class="card-title"><i class="fas fa-receipt mr-2"></i>Chi phí chờ duyệt</h3>
                    <div class="card-tools">
                        <a href="{% url 'portal_team_expenses' %}" class="btn btn-sm btn-light">Xem tất cả</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if pending_expenses %}
                        <table class="table table-sm">
                            <tbody>
                                {% for expense in pending_expenses %}
                                <tr>
                                    <td style="width: 40px;">
                                        {% if expense.employee.avatar %}
                                            <img src="{{ expense.employee.avatar.url }}" 
                                                 class="img-circle" 
                                                 style="width: 35px; height: 35px; object-fit: cover;">
                                        {% else %}
                                            <div class="img-circle bg-primary d-flex align-items-center justify-content-center" 
                                                 style="width: 35px; height: 35px;">
                                                <strong>{{ expense.employee.name|slice:":1" }}</strong>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ expense.employee.name }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ expense.date|date:"d/m/Y" }} - 
                                            <strong class="text-primary">{{ expense.amount|floatformat:0|intcomma }}đ</strong>
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">
                                            {{ expense.category.name }}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <button type="button" class="btn btn-xs btn-success" 
                                                onclick="approveExpense({{ expense.id }})"
                                                title="Duyệt">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-xs btn-danger" 
                                                onclick="rejectExpense({{ expense.id }})"
                                                title="Từ chối">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="p-3 text-center text-muted">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <p>Không có chi phí chờ duyệt</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Team Members Summary -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-users mr-2"></i>Nhân viên trong team</h3>
                </div>
                <div class="card-body">
                    {% if team_members %}
                        <div class="row">
                            {% for member in team_members %}
                            <div class="col-md-3 col-sm-6">
                                <div class="info-box">
                                    <span class="info-box-icon bg-info">
                                        {% if member.avatar %}
                                            <img src="{{ member.avatar.url }}" 
                                                 class="img-circle" 
                                                 style="width: 50px; height: 50px; object-fit: cover;">
                                        {% else %}
                                            <i class="fas fa-user"></i>
                                        {% endif %}
                                    </span>
                                    <div class="info-box-content">
                                        <span class="info-box-text"><strong>{{ member.name }}</strong></span>
                                        <span class="info-box-number text-sm">{{ member.job_title }}</span>
                                        <span class="info-box-number text-sm">{{ member.phone }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle"></i>
                            Chưa có nhân viên trong team
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Approve leave request
function approveLeave(leaveId) {
    Swal.fire({
        title: 'Duyệt đơn nghỉ phép?',
        text: "Bạn có chắc chắn muốn duyệt đơn này không?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Duyệt',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/portal/team/leaves/${leaveId}/approve/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        Swal.fire('Thành công!', data.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Lỗi!', data.message, 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'Không thể duyệt đơn';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    Swal.fire('Lỗi!', errorMsg, 'error');
                }
            });
        }
    });
}

// Reject leave request
function rejectLeave(leaveId) {
    Swal.fire({
        title: 'Từ chối đơn nghỉ phép?',
        text: "Vui lòng nhập lý do từ chối:",
        input: 'textarea',
        inputPlaceholder: 'Nhập lý do từ chối...',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Từ chối',
        cancelButtonText: 'Hủy',
        inputValidator: (value) => {
            if (!value) {
                return 'Bạn cần nhập lý do từ chối!'
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/portal/team/leaves/${leaveId}/reject/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    reason: result.value
                }),
                success: function(data) {
                    if (data.success) {
                        Swal.fire('Thành công!', data.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Lỗi!', data.message, 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'Không thể từ chối đơn';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    Swal.fire('Lỗi!', errorMsg, 'error');
                }
            });
        }
    });
}

// Approve expense request
function approveExpense(expenseId) {
    Swal.fire({
        title: 'Duyệt đơn hoàn tiền?',
        text: "Bạn có chắc chắn muốn duyệt đơn này không?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Duyệt',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/portal/team/expenses/${expenseId}/approve/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.success) {
                        Swal.fire('Thành công!', data.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Lỗi!', data.message, 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'Không thể duyệt đơn';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    Swal.fire('Lỗi!', errorMsg, 'error');
                }
            });
        }
    });
}

// Reject expense request
function rejectExpense(expenseId) {
    Swal.fire({
        title: 'Từ chối đơn hoàn tiền?',
        text: "Vui lòng nhập lý do từ chối:",
        input: 'textarea',
        inputPlaceholder: 'Nhập lý do từ chối...',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Từ chối',
        cancelButtonText: 'Hủy',
        inputValidator: (value) => {
            if (!value) {
                return 'Bạn cần nhập lý do từ chối!'
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/portal/team/expenses/${expenseId}/reject/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    reason: result.value
                }),
                success: function(data) {
                    if (data.success) {
                        Swal.fire('Thành công!', data.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Lỗi!', data.message, 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'Không thể từ chối đơn';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    Swal.fire('Lỗi!', errorMsg, 'error');
                }
            });
        }
    });
}
</script>
{% endblock %}
