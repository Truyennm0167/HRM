{% extends 'portal/portal_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Chi tiết đơn hoàn tiền{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-receipt mr-2"></i>Chi tiết đơn hoàn tiền</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'portal_dashboard' %}">Portal</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'portal_expenses' %}">Chi phí</a></li>
                    <li class="breadcrumb-item active">Chi tiết</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Expense Details Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Thông tin đơn</h3>
                    <div class="card-tools">
                        {% if expense.status == 'pending' %}
                            <span class="badge badge-warning"><i class="fas fa-clock"></i> Chờ duyệt</span>
                        {% elif expense.status == 'approved' %}
                            <span class="badge badge-success"><i class="fas fa-check"></i> Đã duyệt</span>
                        {% elif expense.status == 'rejected' %}
                            <span class="badge badge-danger"><i class="fas fa-times"></i> Bị từ chối</span>
                        {% elif expense.status == 'cancelled' %}
                            <span class="badge badge-secondary"><i class="fas fa-ban"></i> Đã hủy</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tr>
                            <th width="30%"><i class="fas fa-tag mr-2"></i>Loại chi phí</th>
                            <td><span class="badge badge-info">{{ expense.category.name }}</span></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar-day mr-2"></i>Ngày phát sinh</th>
                            <td><strong>{{ expense.date|date:"d/m/Y" }}</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-money-bill-wave mr-2"></i>Số tiền</th>
                            <td><strong class="text-primary">{{ expense.amount|floatformat:0|intcomma }}đ</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-comment-alt mr-2"></i>Mô tả</th>
                            <td>{{ expense.description }}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-file mr-2"></i>Hóa đơn/Chứng từ</th>
                            <td>
                                {% if expense.receipt %}
                                    <a href="{{ expense.receipt.url }}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="fas fa-download mr-1"></i> Tải xuống
                                    </a>
                                {% else %}
                                    <span class="text-muted">Không có</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-clock mr-2"></i>Ngày tạo</th>
                            <td>{{ expense.created_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% if expense.approved_date %}
                        <tr>
                            <th><i class="fas fa-clock mr-2"></i>Ngày phê duyệt</th>
                            <td>{{ expense.approved_date|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% endif %}
                        {% if expense.approved_by %}
                        <tr>
                            <th><i class="fas fa-user-check mr-2"></i>Người phê duyệt</th>
                            <td>{{ expense.approved_by.name }}</td>
                        </tr>
                        {% endif %}
                        {% if expense.notes %}
                        <tr>
                            <th><i class="fas fa-comment-dots mr-2"></i>Ghi chú</th>
                            <td>
                                <div class="alert alert-{% if expense.status == 'approved' %}success{% elif expense.status == 'rejected' %}danger{% else %}info{% endif %}">
                                    {{ expense.notes }}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </table>

                    <!-- Actions -->
                    <div class="mt-3">
                        {% if is_manager_view and expense.status == 'pending' %}
                        <button type="button" class="btn btn-success" onclick="approveExpense()">
                            <i class="fas fa-check mr-1"></i> Duyệt
                        </button>
                        <button type="button" class="btn btn-danger" onclick="rejectExpense()">
                            <i class="fas fa-times mr-1"></i> Từ chối
                        </button>
                        {% elif expense.status == 'pending' and not is_manager_view %}
                        <button type="button" class="btn btn-danger" onclick="cancelExpense()">
                            <i class="fas fa-times mr-1"></i> Hủy đơn
                        </button>
                        {% endif %}
                        <a href="{% if is_manager_view %}{% url 'portal_team_expenses' %}{% else %}{% url 'portal_expenses' %}{% endif %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left mr-1"></i> Quay lại
                        </a>
                    </div>
                </div>
            </div>

            <!-- Receipt Preview -->
            {% if expense.receipt %}
            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-image mr-2"></i>Xem trước hóa đơn</h3>
                </div>
                <div class="card-body text-center">
                    {% if expense.receipt.url|slice:"-4:" == '.pdf' %}
                        <iframe src="{{ expense.receipt.url }}" style="width: 100%; height: 600px;" frameborder="0"></iframe>
                    {% else %}
                        <img src="{{ expense.receipt.url }}" alt="Receipt" class="img-fluid" style="max-height: 600px;">
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            <!-- Timeline Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history mr-2"></i>Lịch sử</h3>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Created -->
                        <div class="time-label">
                            <span class="bg-primary">{{ expense.created_at|date:"d/m/Y" }}</span>
                        </div>
                        <div>
                            <i class="fas fa-file bg-info"></i>
                            <div class="timeline-item">
                                <span class="time"><i class="fas fa-clock"></i> {{ expense.created_at|date:"H:i" }}</span>
                                <h3 class="timeline-header">Đơn được tạo</h3>
                                <div class="timeline-body">
                                    Bạn đã tạo đơn hoàn tiền {{ expense.get_expense_type_display }}
                                </div>
                            </div>
                        </div>

                        <!-- Approved/Rejected -->
                        {% if expense.approved_date %}
                        <div class="time-label">
                            <span class="bg-{% if expense.status == 'approved' %}success{% elif expense.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                                {{ expense.approved_date|date:"d/m/Y" }}
                            </span>
                        </div>
                        <div>
                            <i class="fas {% if expense.status == 'approved' %}fa-check bg-success{% elif expense.status == 'rejected' %}fa-times bg-danger{% else %}fa-ban bg-secondary{% endif %}"></i>
                            <div class="timeline-item">
                                <span class="time"><i class="fas fa-clock"></i> {{ expense.approved_date|date:"H:i" }}</span>
                                <h3 class="timeline-header">
                                    {% if expense.status == 'approved' %}
                                        Đơn đã được duyệt
                                    {% elif expense.status == 'rejected' %}
                                        Đơn bị từ chối
                                    {% elif expense.status == 'cancelled' %}
                                        Đơn đã bị hủy
                                    {% endif %}
                                </h3>
                                {% if expense.approved_by %}
                                <div class="timeline-body">
                                    Bởi: {{ expense.approved_by.get_full_name }}
                                </div>
                                {% endif %}
                                {% if expense.notes %}
                                <div class="timeline-body">
                                    Ghi chú: {{ expense.notes }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div>
                            <i class="fas fa-clock bg-gray"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function cancelExpense() {
    Swal.fire({
        title: 'Xác nhận hủy đơn?',
        text: 'Bạn có chắc muốn hủy đơn hoàn tiền này?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Hủy đơn',
        cancelButtonText: 'Đóng'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/portal/expenses/{{ expense.id }}/cancel/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Thành công!', 'Đã hủy đơn thành công!', 'success').then(() => {
                        window.location.href = "{% url 'portal_expenses' %}";
                    });
                } else {
                    Swal.fire('Lỗi!', data.message || 'Không thể hủy đơn', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi!', 'Có lỗi xảy ra khi hủy đơn', 'error');
            });
        }
    });
}

function approveExpense() {
    Swal.fire({
        title: 'Duyệt đơn hoàn tiền?',
        text: 'Bạn có chắc muốn duyệt đơn này?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Duyệt',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/portal/team/expenses/{{ expense.id }}/approve/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Thành công!', data.message || 'Đã duyệt đơn thành công!', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Lỗi!', data.message || 'Không thể duyệt đơn', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi!', 'Có lỗi xảy ra khi duyệt đơn', 'error');
            });
        }
    });
}

function rejectExpense() {
    Swal.fire({
        title: 'Từ chối đơn hoàn tiền?',
        input: 'textarea',
        inputLabel: 'Lý do từ chối',
        inputPlaceholder: 'Nhập lý do từ chối...',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Từ chối',
        cancelButtonText: 'Hủy',
        inputValidator: (value) => {
            if (!value) {
                return 'Vui lòng nhập lý do từ chối!'
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/portal/team/expenses/{{ expense.id }}/reject/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: result.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Thành công!', data.message || 'Đã từ chối đơn thành công!', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Lỗi!', data.message || 'Không thể từ chối đơn', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi!', 'Có lỗi xảy ra khi từ chối đơn', 'error');
            });
        }
    });
}
</script>
{% endblock %}
