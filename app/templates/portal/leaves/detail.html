{% extends 'portal/portal_base.html' %}
{% load static %}

{% block title %}Chi tiết đơn nghỉ phép{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-file-alt mr-2"></i>Chi tiết đơn nghỉ phép</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'portal_dashboard' %}">Portal</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'portal_leaves' %}">Nghỉ phép</a></li>
                    <li class="breadcrumb-item active">Chi tiết</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Leave Details Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Thông tin đơn</h3>
                    <div class="card-tools">
                        {% if leave.status == 'pending' %}
                            <span class="badge badge-warning"><i class="fas fa-clock"></i> Chờ duyệt</span>
                        {% elif leave.status == 'approved' %}
                            <span class="badge badge-success"><i class="fas fa-check"></i> Đã duyệt</span>
                        {% elif leave.status == 'rejected' %}
                            <span class="badge badge-danger"><i class="fas fa-times"></i> Bị từ chối</span>
                        {% elif leave.status == 'cancelled' %}
                            <span class="badge badge-secondary"><i class="fas fa-ban"></i> Đã hủy</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tr>
                            <th width="30%"><i class="fas fa-tag mr-2"></i>Loại phép</th>
                            <td><span class="badge badge-info">{{ leave.get_leave_type_display }}</span></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar-day mr-2"></i>Từ ngày</th>
                            <td><strong>{{ leave.start_date|date:"d/m/Y" }}</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar-day mr-2"></i>Đến ngày</th>
                            <td><strong>{{ leave.end_date|date:"d/m/Y" }}</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calculator mr-2"></i>Tổng số ngày</th>
                            <td><span class="badge badge-primary">{{ leave.total_days }} ngày</span></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-comment-alt mr-2"></i>Lý do</th>
                            <td>{{ leave.reason }}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-clock mr-2"></i>Ngày tạo</th>
                            <td>{{ leave.created_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% if leave.response_date %}
                        <tr>
                            <th><i class="fas fa-clock mr-2"></i>Ngày phản hồi</th>
                            <td>{{ leave.response_date|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% endif %}
                        {% if leave.response_message %}
                        <tr>
                            <th><i class="fas fa-comment-dots mr-2"></i>Phản hồi</th>
                            <td>
                                <div class="alert alert-{% if leave.status == 'approved' %}success{% elif leave.status == 'rejected' %}danger{% else %}info{% endif %}">
                                    {{ leave.response_message }}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </table>

                    <!-- Actions -->
                    <div class="mt-3">
                        {% if leave.status == 'pending' %}
                        <button type="button" class="btn btn-danger" onclick="cancelLeave()">
                            <i class="fas fa-times mr-1"></i> Hủy đơn
                        </button>
                        {% endif %}
                        <a href="{% url 'portal_leaves_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left mr-1"></i> Quay lại
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Timeline Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history mr-2"></i>Lịch sử</h3>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Created -->
                        <div class="time-label">
                            <span class="bg-primary">{{ leave.created_at|date:"d/m/Y" }}</span>
                        </div>
                        <div>
                            <i class="fas fa-file bg-info"></i>
                            <div class="timeline-item">
                                <span class="time"><i class="fas fa-clock"></i> {{ leave.created_at|date:"H:i" }}</span>
                                <h3 class="timeline-header">Đơn được tạo</h3>
                                <div class="timeline-body">
                                    Bạn đã tạo đơn xin nghỉ phép {{ leave.get_leave_type_display }}
                                </div>
                            </div>
                        </div>

                        <!-- Response -->
                        {% if leave.response_date %}
                        <div class="time-label">
                            <span class="bg-{% if leave.status == 'approved' %}success{% elif leave.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                                {{ leave.response_date|date:"d/m/Y" }}
                            </span>
                        </div>
                        <div>
                            <i class="fas {% if leave.status == 'approved' %}fa-check bg-success{% elif leave.status == 'rejected' %}fa-times bg-danger{% else %}fa-ban bg-secondary{% endif %}"></i>
                            <div class="timeline-item">
                                <span class="time"><i class="fas fa-clock"></i> {{ leave.response_date|date:"H:i" }}</span>
                                <h3 class="timeline-header">
                                    {% if leave.status == 'approved' %}
                                        Đơn đã được duyệt
                                    {% elif leave.status == 'rejected' %}
                                        Đơn bị từ chối
                                    {% elif leave.status == 'cancelled' %}
                                        Đơn đã bị hủy
                                    {% endif %}
                                </h3>
                                {% if leave.response_message %}
                                <div class="timeline-body">
                                    {{ leave.response_message }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div>
                            <i class="fas fa-clock bg-gray"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function cancelLeave() {
    if (confirm('Bạn có chắc muốn hủy đơn nghỉ phép này?')) {
        fetch(`/portal/leaves/{{ leave.id }}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{% url 'portal_leaves_list' %}";
            } else {
                alert('Lỗi: ' + (data.message || 'Không thể hủy đơn'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi hủy đơn');
        });
    }
}
</script>
{% endblock %}
