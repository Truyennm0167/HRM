{% extends 'portal/portal_base.html' %}
{% load static %}

{% block title %}Chi tiết đơn nghỉ phép{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-file-alt mr-2"></i>Chi tiết đơn nghỉ phép</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'portal_dashboard' %}">Portal</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'portal_leaves' %}">Nghỉ phép</a></li>
                    <li class="breadcrumb-item active">Chi tiết</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Leave Details Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Thông tin đơn</h3>
                    <div class="card-tools">
                        {% if leave_request.status == 'pending' %}
                            <span class="badge badge-warning"><i class="fas fa-clock"></i> Chờ duyệt</span>
                        {% elif leave_request.status == 'approved' %}
                            <span class="badge badge-success"><i class="fas fa-check"></i> Đã duyệt</span>
                        {% elif leave_request.status == 'rejected' %}
                            <span class="badge badge-danger"><i class="fas fa-times"></i> Bị từ chối</span>
                        {% elif leave_request.status == 'cancelled' %}
                            <span class="badge badge-secondary"><i class="fas fa-ban"></i> Đã hủy</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tr>
                            <th width="30%"><i class="fas fa-tag mr-2"></i>Loại phép</th>
                            <td><span class="badge badge-info">{{ leave_request.leave_type.name }}</span></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar-day mr-2"></i>Từ ngày</th>
                            <td><strong>{{ leave_request.start_date|date:"d/m/Y" }}</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar-day mr-2"></i>Đến ngày</th>
                            <td><strong>{{ leave_request.end_date|date:"d/m/Y" }}</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calculator mr-2"></i>Tổng số ngày</th>
                            <td><span class="badge badge-primary">{{ leave_request.total_days }} ngày</span></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-comment-alt mr-2"></i>Lý do</th>
                            <td>{{ leave_request.reason }}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-clock mr-2"></i>Ngày tạo</th>
                            <td>{{ leave_request.created_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% if leave_request.response_date %}
                        <tr>
                            <th><i class="fas fa-clock mr-2"></i>Ngày phản hồi</th>
                            <td>{{ leave_request.response_date|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% endif %}
                        {% if leave_request.response_message %}
                        <tr>
                            <th><i class="fas fa-comment-dots mr-2"></i>Phản hồi</th>
                            <td>
                                <div class="alert alert-{% if leave_request.status == 'approved' %}success{% elif leave_request.status == 'rejected' %}danger{% else %}info{% endif %}">
                                    {{ leave_request.response_message }}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </table>

                    <!-- Actions -->
                    <div class="mt-3">
                        {% if is_manager_view and leave_request.status == 'pending' %}
                        <button type="button" class="btn btn-success" onclick="approveLeave()">
                            <i class="fas fa-check mr-1"></i> Duyệt
                        </button>
                        <button type="button" class="btn btn-danger" onclick="rejectLeave()">
                            <i class="fas fa-times mr-1"></i> Từ chối
                        </button>
                        {% elif leave_request.status == 'pending' and not is_manager_view %}
                        <button type="button" class="btn btn-danger" onclick="cancelLeave()">
                            <i class="fas fa-times mr-1"></i> Hủy đơn
                        </button>
                        {% endif %}
                        <a href="{% if is_manager_view %}{% url 'portal_team_leaves' %}{% else %}{% url 'portal_leaves' %}{% endif %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left mr-1"></i> Quay lại
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Timeline Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history mr-2"></i>Lịch sử</h3>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Created -->
                        <div class="time-label">
                            <span class="bg-primary">{{ leave_request.created_at|date:"d/m/Y" }}</span>
                        </div>
                        <div>
                            <i class="fas fa-file bg-info"></i>
                            <div class="timeline-item">
                                <span class="time"><i class="fas fa-clock"></i> {{ leave_request.created_at|date:"H:i" }}</span>
                                <h3 class="timeline-header">Đơn được tạo</h3>
                                <div class="timeline-body">
                                    Bạn đã tạo đơn xin nghỉ phép {{ leave_request.leave_type.name }}
                                </div>
                            </div>
                        </div>

                        <!-- Response -->
                        {% if leave_request.response_date %}
                        <div class="time-label">
                            <span class="bg-{% if leave_request.status == 'approved' %}success{% elif leave_request.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                                {{ leave_request.response_date|date:"d/m/Y" }}
                            </span>
                        </div>
                        <div>
                            <i class="fas {% if leave_request.status == 'approved' %}fa-check bg-success{% elif leave_request.status == 'rejected' %}fa-times bg-danger{% else %}fa-ban bg-secondary{% endif %}"></i>
                            <div class="timeline-item">
                                <span class="time"><i class="fas fa-clock"></i> {{ leave_request.response_date|date:"H:i" }}</span>
                                <h3 class="timeline-header">
                                    {% if leave_request.status == 'approved' %}
                                        Đơn đã được duyệt
                                    {% elif leave_request.status == 'rejected' %}
                                        Đơn bị từ chối
                                    {% elif leave_request.status == 'cancelled' %}
                                        Đơn đã bị hủy
                                    {% endif %}
                                </h3>
                                {% if leave_request.response_message %}
                                <div class="timeline-body">
                                    {{ leave_request.response_message }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div>
                            <i class="fas fa-clock bg-gray"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function cancelLeave() {
    Swal.fire({
        title: 'Xác nhận hủy đơn?',
        text: 'Bạn có chắc muốn hủy đơn nghỉ phép này?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Hủy đơn',
        cancelButtonText: 'Đóng'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/portal/leaves/{{ leave_request.id }}/cancel/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Thành công!', data.message || 'Đã hủy đơn thành công!', 'success').then(() => {
                        window.location.href = "{% url 'portal_leaves' %}";
                    });
                } else {
                    Swal.fire('Lỗi!', data.message || 'Không thể hủy đơn', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi!', 'Có lỗi xảy ra khi hủy đơn', 'error');
            });
        }
    });
}

function approveLeave() {
    Swal.fire({
        title: 'Duyệt đơn nghỉ phép?',
        text: 'Bạn có chắc muốn duyệt đơn này?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Duyệt',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/portal/team/leaves/{{ leave_request.id }}/approve/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Thành công!', data.message || 'Đã duyệt đơn thành công!', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Lỗi!', data.message || 'Không thể duyệt đơn', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi!', 'Có lỗi xảy ra khi duyệt đơn', 'error');
            });
        }
    });
}

function rejectLeave() {
    Swal.fire({
        title: 'Từ chối đơn nghỉ phép?',
        input: 'textarea',
        inputLabel: 'Lý do từ chối',
        inputPlaceholder: 'Nhập lý do từ chối...',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Từ chối',
        cancelButtonText: 'Hủy',
        inputValidator: (value) => {
            if (!value) {
                return 'Vui lòng nhập lý do từ chối!'
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/portal/team/leaves/{{ leave_request.id }}/reject/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: result.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Thành công!', data.message || 'Đã từ chối đơn thành công!', 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('Lỗi!', data.message || 'Không thể từ chối đơn', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi!', 'Có lỗi xảy ra khi từ chối đơn', 'error');
            });
        }
    });
}
</script>
{% endblock %}
