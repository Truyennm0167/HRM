{% extends 'hod_template/base_template.html' %}
{% load permission_tags %}

{% block page_title %}
Chi Tiết Chi Phí
{% endblock page_title %}

{% block main_content %}
<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-file-invoice-dollar"></i> Chi Tiết Chi Phí #{{ expense.id }}</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'manage_expenses' %}">Quản lý chi phí</a></li>
                    <li class="breadcrumb-item active">Chi tiết</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Expense Details -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info-circle"></i> Thông Tin Chi Phí</h3>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <th width="30%">Mã chi phí</th>
                                <td>{{ expense.id }}</td>
                            </tr>
                            <tr>
                                <th>Nhân viên</th>
                                <td>
                                    {{ expense.employee.name }}
                                    <span class="badge badge-secondary">{{ expense.employee.employee_code }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Danh mục</th>
                                <td>{{ expense.category.name }}</td>
                            </tr>
                            <tr>
                                <th>Số tiền</th>
                                <td class="text-bold text-lg">{{ expense.amount|floatformat:0 }} VND</td>
                            </tr>
                            <tr>
                                <th>Ngày phát sinh</th>
                                <td>{{ expense.date|date:"d/m/Y" }}</td>
                            </tr>
                            <tr>
                                <th>Trạng thái</th>
                                <td>
                                    {% if expense.status == 'pending' %}
                                        <span class="badge badge-warning badge-lg">Chờ duyệt</span>
                                    {% elif expense.status == 'approved' %}
                                        <span class="badge badge-success badge-lg">Đã duyệt</span>
                                    {% elif expense.status == 'rejected' %}
                                        <span class="badge badge-danger badge-lg">Từ chối</span>
                                    {% elif expense.status == 'paid' %}
                                        <span class="badge badge-primary badge-lg">Đã thanh toán</span>
                                    {% elif expense.status == 'cancelled' %}
                                        <span class="badge badge-secondary badge-lg">Đã hủy</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Mô tả</th>
                                <td>{{ expense.description|linebreaks }}</td>
                            </tr>
                            <tr>
                                <th>Ngày tạo</th>
                                <td>{{ expense.created_at|date:"H:i d/m/Y" }}</td>
                            </tr>
                            {% if expense.approved_by %}
                            <tr>
                                <th>Người duyệt</th>
                                <td>{{ expense.approved_by.name }}</td>
                            </tr>
                            <tr>
                                <th>Ngày duyệt</th>
                                <td>{{ expense.approved_at|date:"H:i d/m/Y" }}</td>
                            </tr>
                            {% endif %}
                            {% if expense.paid_by %}
                            <tr>
                                <th>Người thanh toán</th>
                                <td>{{ expense.paid_by.name }}</td>
                            </tr>
                            <tr>
                                <th>Ngày thanh toán</th>
                                <td>{{ expense.paid_at|date:"H:i d/m/Y" }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    <div class="card-footer">
                        <a href="{% url 'manage_expenses' %}" class="btn btn-default">
                            <i class="fas fa-arrow-left"></i> Quay Lại
                        </a>
                        {% if expense.status == 'pending' and request.user|user_in_groups:'HR,Manager' %}
                            <button type="button" class="btn btn-success" onclick="approveExpense()">
                                <i class="fas fa-check"></i> Duyệt
                            </button>
                            <button type="button" class="btn btn-danger" onclick="rejectExpense()">
                                <i class="fas fa-times"></i> Từ Chối
                            </button>
                        {% elif expense.status == 'approved' and request.user|user_in_group:'HR' %}
                            <button type="button" class="btn btn-primary" onclick="markAsPaid()">
                                <i class="fas fa-dollar-sign"></i> Đánh Dấu Đã Thanh Toán
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Receipt Image -->
            <div class="col-md-4">
                {% if expense.receipt %}
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-image"></i> Hóa Đơn/Biên Lai</h3>
                    </div>
                    <div class="card-body text-center">
                        <a href="{{ expense.receipt.url }}" data-toggle="lightbox" data-title="Hóa đơn - Chi phí #{{ expense.id }}">
                            <img src="{{ expense.receipt.url }}" alt="Receipt" class="img-fluid img-thumbnail">
                        </a>
                        <div class="mt-3">
                            <a href="{{ expense.receipt.url }}" target="_blank" class="btn btn-primary btn-sm">
                                <i class="fas fa-download"></i> Tải Xuống
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-image"></i> Hóa Đơn/Biên Lai</h3>
                    </div>
                    <div class="card-body text-center text-muted">
                        <i class="fas fa-file-image fa-3x mb-3"></i>
                        <p>Không có hóa đơn đính kèm</p>
                    </div>
                </div>
                {% endif %}

                <!-- Timeline -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> Lịch Sử</h3>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            <div class="time-label">
                                <span class="bg-secondary">{{ expense.created_at|date:"d/m/Y" }}</span>
                            </div>
                            
                            <div>
                                <i class="fas fa-plus bg-primary"></i>
                                <div class="timeline-item">
                                    <span class="time">
                                        <i class="fas fa-clock"></i> {{ expense.created_at|date:"H:i" }}
                                    </span>
                                    <h3 class="timeline-header">Tạo yêu cầu</h3>
                                    <div class="timeline-body">
                                        {{ expense.employee.name }} đã tạo yêu cầu chi phí
                                    </div>
                                </div>
                            </div>
                            
                            {% if expense.approved_at %}
                            <div class="time-label">
                                <span class="bg-secondary">{{ expense.approved_at|date:"d/m/Y" }}</span>
                            </div>
                            
                            <div>
                                {% if expense.status == 'approved' or expense.status == 'paid' %}
                                    <i class="fas fa-check bg-success"></i>
                                    <div class="timeline-item">
                                        <span class="time">
                                            <i class="fas fa-clock"></i> {{ expense.approved_at|date:"H:i" }}
                                        </span>
                                        <h3 class="timeline-header">Đã duyệt</h3>
                                        <div class="timeline-body">
                                            {{ expense.approved_by.name }} đã duyệt yêu cầu
                                        </div>
                                    </div>
                                {% elif expense.status == 'rejected' %}
                                    <i class="fas fa-times bg-danger"></i>
                                    <div class="timeline-item">
                                        <span class="time">
                                            <i class="fas fa-clock"></i> {{ expense.approved_at|date:"H:i" }}
                                        </span>
                                        <h3 class="timeline-header">Từ chối</h3>
                                        <div class="timeline-body">
                                            {{ expense.approved_by.name }} đã từ chối yêu cầu
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            {% if expense.paid_at %}
                            <div class="time-label">
                                <span class="bg-secondary">{{ expense.paid_at|date:"d/m/Y" }}</span>
                            </div>
                            
                            <div>
                                <i class="fas fa-dollar-sign bg-primary"></i>
                                <div class="timeline-item">
                                    <span class="time">
                                        <i class="fas fa-clock"></i> {{ expense.paid_at|date:"H:i" }}
                                    </span>
                                    <h3 class="timeline-header">Đã thanh toán</h3>
                                    <div class="timeline-body">
                                        {{ expense.paid_by.name }} đã thanh toán
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div>
                                <i class="fas fa-clock bg-gray"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title">Xác Nhận Duyệt</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'approve_expense' expense.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn duyệt yêu cầu chi phí này?</p>
                    <p class="text-bold">Số tiền: {{ expense.amount|floatformat:0 }} VND</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-success">Xác Nhận Duyệt</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title">Xác Nhận Từ Chối</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'reject_expense' expense.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label>Lý do từ chối <span class="text-danger">*</span></label>
                        <textarea name="rejection_reason" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-danger">Xác Nhận Từ Chối</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Mark as Paid Modal -->
<div class="modal fade" id="paidModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title">Xác Nhận Thanh Toán</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'mark_expense_as_paid' expense.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Xác nhận chi phí này đã được thanh toán?</p>
                    <p class="text-bold">Số tiền: {{ expense.amount|floatformat:0 }} VND</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Xác Nhận</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function approveExpense() {
    $('#approveModal').modal('show');
}

function rejectExpense() {
    $('#rejectModal').modal('show');
}

function markAsPaid() {
    $('#paidModal').modal('show');
}

// Initialize lightbox for receipt image
$(document).on('click', '[data-toggle="lightbox"]', function(event) {
    event.preventDefault();
    $(this).ekkoLightbox();
});
</script>
{% endblock main_content %}
