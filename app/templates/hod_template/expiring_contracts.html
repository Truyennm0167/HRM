{% extends 'hod_template/base_template.html' %}
{% load static %}

{% block page_title %}
Hợp đồng sắp hết hạn
{% endblock page_title %}

{% block main_content %}
<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-exclamation-triangle text-warning"></i> Hợp đồng sắp hết hạn</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'manage_contracts' %}">Hợp đồng</a></li>
                    <li class="breadcrumb-item active">Sắp hết hạn</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Alert -->
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle"></i> Cảnh báo!</h5>
            <p>Danh sách các hợp đồng sẽ hết hạn trong vòng <strong>{{ days_ahead }} ngày tới</strong>.</p>
            <p class="mb-0">Vui lòng liên hệ nhân viên để gia hạn hoặc chấm dứt hợp đồng kịp thời.</p>
        </div>

        <!-- Filter Days -->
        <div class="card">
            <div class="card-body">
                <form method="get" class="form-inline">
                    <label class="mr-2">Hiển thị hợp đồng hết hạn trong:</label>
                    <select name="days" class="form-control mr-2" onchange="this.form.submit()">
                        <option value="7" {% if days_ahead == 7 %}selected{% endif %}>7 ngày</option>
                        <option value="15" {% if days_ahead == 15 %}selected{% endif %}>15 ngày</option>
                        <option value="30" {% if days_ahead == 30 %}selected{% endif %}>30 ngày</option>
                        <option value="60" {% if days_ahead == 60 %}selected{% endif %}>60 ngày</option>
                        <option value="90" {% if days_ahead == 90 %}selected{% endif %}>90 ngày</option>
                    </select>
                    <a href="{% url 'manage_contracts' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>
                </form>
            </div>
        </div>

        <!-- Expiring Contracts List -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-list"></i> 
                    Danh sách hợp đồng ({{ contracts.count }} hợp đồng)
                </h3>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã HĐ</th>
                            <th>Nhân viên</th>
                            <th>Phòng ban</th>
                            <th>Loại HĐ</th>
                            <th>Ngày bắt đầu</th>
                            <th>Ngày kết thúc</th>
                            <th>Còn lại</th>
                            <th>Mức độ</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for contract in contracts %}
                        {% with days_left=contract.days_until_expiry %}
                        <tr class="{% if days_left <= 7 %}table-danger{% elif days_left <= 15 %}table-warning{% endif %}">
                            <td>{{ forloop.counter }}</td>
                            <td><strong>{{ contract.contract_code }}</strong></td>
                            <td>
                                <strong>{{ contract.employee.name }}</strong><br>
                                <small class="text-muted">{{ contract.employee.employee_code }}</small>
                            </td>
                            <td>{{ contract.department.name|default:"N/A" }}</td>
                            <td>{{ contract.get_contract_type_display }}</td>
                            <td>{{ contract.start_date|date:"d/m/Y" }}</td>
                            <td>{{ contract.end_date|date:"d/m/Y" }}</td>
                            <td>
                                <strong class="{% if days_left <= 7 %}text-danger{% elif days_left <= 15 %}text-warning{% else %}text-info{% endif %}">
                                    {{ days_left }} ngày
                                </strong>
                            </td>
                            <td>
                                {% if days_left <= 7 %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-fire"></i> Khẩn cấp
                                    </span>
                                {% elif days_left <= 15 %}
                                    <span class="badge badge-warning">
                                        <i class="fas fa-exclamation-triangle"></i> Cảnh báo
                                    </span>
                                {% else %}
                                    <span class="badge badge-info">
                                        <i class="fas fa-info-circle"></i> Lưu ý
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'contract_detail' contract.id %}" 
                                       class="btn btn-info btn-sm" title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button" class="btn btn-success btn-sm" 
                                            data-toggle="modal" 
                                            data-target="#renewModal{{ contract.id }}"
                                            title="Gia hạn">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    <a href="mailto:{{ contract.employee.email }}?subject=Gia hạn hợp đồng {{ contract.contract_code }}" 
                                       class="btn btn-warning btn-sm" title="Gửi email">
                                        <i class="fas fa-envelope"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Renew Modal for each contract -->
                        <div class="modal fade" id="renewModal{{ contract.id }}" tabindex="-1" role="dialog">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'renew_contract' contract.id %}">
                                        {% csrf_token %}
                                        <div class="modal-header bg-success">
                                            <h5 class="modal-title">Gia hạn hợp đồng {{ contract.contract_code }}</h5>
                                            <button type="button" class="close" data-dismiss="modal">
                                                <span>&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <p><strong>Nhân viên:</strong> {{ contract.employee.name }}</p>
                                            <p><strong>HĐ hiện tại:</strong> {{ contract.start_date|date:"d/m/Y" }} - {{ contract.end_date|date:"d/m/Y" }}</p>
                                            <hr>
                                            <div class="form-group">
                                                <label>Ngày bắt đầu mới: <span class="text-danger">*</span></label>
                                                <input type="date" name="new_start_date" class="form-control" 
                                                       value="{{ contract.end_date|date:'Y-m-d' }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label>Ngày kết thúc mới:</label>
                                                <input type="date" name="new_end_date" class="form-control">
                                                <small class="text-muted">Để trống nếu không xác định thời hạn</small>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                                            <button type="submit" class="btn btn-success">Xác nhận gia hạn</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center text-muted">
                                <i class="fas fa-check-circle fa-3x mb-3 d-block text-success"></i>
                                <h5>Không có hợp đồng nào sắp hết hạn trong {{ days_ahead }} ngày tới!</h5>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary Statistics -->
        {% if contracts %}
        <div class="row">
            <div class="col-md-4">
                <div class="info-box bg-danger">
                    <span class="info-box-icon"><i class="fas fa-fire"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Khẩn cấp (≤ 7 ngày)</span>
                        <span class="info-box-number">{{ urgent_count }} hợp đồng</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-box bg-warning">
                    <span class="info-box-icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Cảnh báo (≤ 15 ngày)</span>
                        <span class="info-box-number">{{ warning_count }} hợp đồng</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-box bg-info">
                    <span class="info-box-icon"><i class="fas fa-info-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Lưu ý (> 15 ngày)</span>
                        <span class="info-box-number">{{ notice_count }} hợp đồng</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</section>
{% endblock main_content %}
