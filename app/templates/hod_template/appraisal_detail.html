{% extends 'hod_template/base_template.html' %}
{% load static %}

{% block page_title %}Chi Tiết Đánh Giá{% endblock page_title %}

{% block main_content %}
<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Chi Tiết Đánh Giá</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Trang chủ</a></li>
                    <li class="breadcrumb-item active">Chi tiết đánh giá</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Employee Info -->
            <div class="col-md-3">
                <div class="card card-primary card-outline">
                    <div class="card-body box-profile">
                        <div class="text-center">
                            {% if appraisal.employee.avatar %}
                                <img class="profile-user-img img-fluid img-circle" 
                                     src="{{ appraisal.employee.avatar.url }}" 
                                     alt="Avatar">
                            {% else %}
                                <img class="profile-user-img img-fluid img-circle" 
                                     src="{% static 'dist/img/user2-160x160.jpg' %}" 
                                     alt="Avatar">
                            {% endif %}
                        </div>

                        <h3 class="profile-username text-center">{{ appraisal.employee.name }}</h3>
                        <p class="text-muted text-center">{{ appraisal.employee.job_title.name }}</p>

                        <ul class="list-group list-group-unbordered mb-3">
                            <li class="list-group-item">
                                <b>Mã NV</b>
                                <span class="float-right">{{ appraisal.employee.employee_code }}</span>
                            </li>
                            <li class="list-group-item">
                                <b>Phòng ban</b>
                                <span class="float-right">{{ appraisal.employee.department.name }}</span>
                            </li>
                            <li class="list-group-item">
                                <b>Quản lý</b>
                                <span class="float-right">{{ appraisal.manager.name|default:"—" }}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Status -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Trạng thái</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-center">
                            {% if appraisal.status == 'pending_self' %}
                                <span class="badge badge-warning badge-lg">Chờ tự đánh giá</span>
                            {% elif appraisal.status == 'pending_manager' %}
                                <span class="badge badge-primary badge-lg">Chờ quản lý</span>
                            {% elif appraisal.status == 'pending_hr' %}
                                <span class="badge badge-info badge-lg">Chờ HR</span>
                            {% elif appraisal.status == 'completed' %}
                                <span class="badge badge-success badge-lg">Hoàn thành</span>
                            {% endif %}
                        </p>

                        <dl class="mt-3">
                            <dt>Tự đánh giá:</dt>
                            <dd>
                                {% if appraisal.self_assessment_date %}
                                    <i class="fas fa-check text-success"></i> {{ appraisal.self_assessment_date|date:"d/m/Y H:i" }}
                                {% else %}
                                    <i class="fas fa-times text-muted"></i> Chưa thực hiện
                                {% endif %}
                            </dd>

                            <dt>Đánh giá quản lý:</dt>
                            <dd>
                                {% if appraisal.manager_review_date %}
                                    <i class="fas fa-check text-success"></i> {{ appraisal.manager_review_date|date:"d/m/Y H:i" }}
                                {% else %}
                                    <i class="fas fa-times text-muted"></i> Chưa thực hiện
                                {% endif %}
                            </dd>

                            <dt>Phê duyệt HR:</dt>
                            <dd>
                                {% if appraisal.final_review_date %}
                                    <i class="fas fa-check text-success"></i> {{ appraisal.final_review_date|date:"d/m/Y H:i" }}
                                {% else %}
                                    <i class="fas fa-times text-muted"></i> Chưa thực hiện
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Period Info -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">Thông tin kỳ đánh giá</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-3">Kỳ đánh giá:</dt>
                            <dd class="col-sm-9"><strong>{{ appraisal.period.name }}</strong></dd>

                            <dt class="col-sm-3">Thời gian:</dt>
                            <dd class="col-sm-9">
                                {{ appraisal.period.start_date|date:"d/m/Y" }} - {{ appraisal.period.end_date|date:"d/m/Y" }}
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Scores Table -->
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">Điểm số theo tiêu chí</h3>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Tiêu chí</th>
                                    <th width="80">Trọng số</th>
                                    <th width="100">Điểm NV</th>
                                    <th width="100">Điểm QL</th>
                                    <th width="100">Điểm cuối</th>
                                    <th>Nhận xét</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for score in scores %}
                                <tr>
                                    <td>
                                        <strong>{{ score.criteria.name }}</strong>
                                        <br><small class="text-muted">{{ score.criteria.description|truncatewords:10 }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-primary">{{ score.criteria.weight }}%</span>
                                    </td>
                                    <td class="text-center">
                                        {% if score.self_score is not None %}
                                            <strong class="text-primary">{{ score.self_score }}</strong> / {{ score.criteria.max_score }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if score.manager_score is not None %}
                                            <strong class="text-info">{{ score.manager_score }}</strong> / {{ score.criteria.max_score }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if score.final_score is not None %}
                                            <strong class="text-success">{{ score.final_score }}</strong> / {{ score.criteria.max_score }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if score.self_comment %}
                                            <small><strong>NV:</strong> {{ score.self_comment|truncatewords:15 }}</small><br>
                                        {% endif %}
                                        {% if score.manager_comment %}
                                            <small><strong>QL:</strong> {{ score.manager_comment|truncatewords:15 }}</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="2"><strong>Điểm tổng</strong></td>
                                    <td class="text-center">
                                        {% if appraisal.self_overall_score %}
                                            <strong class="text-primary">{{ appraisal.self_overall_score }}</strong>
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if appraisal.manager_overall_score %}
                                            <strong class="text-info">{{ appraisal.manager_overall_score }}</strong>
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if appraisal.final_score %}
                                            <strong class="text-success" style="font-size: 1.2em;">{{ appraisal.final_score }}</strong>
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Self Assessment -->
                {% if appraisal.self_assessment %}
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Tự đánh giá của nhân viên</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h5>Tự đánh giá chung</h5>
                            <p>{{ appraisal.self_assessment }}</p>
                        </div>
                        {% if appraisal.self_achievements %}
                        <div class="mb-3">
                            <h5>Thành tích đạt được</h5>
                            <p>{{ appraisal.self_achievements }}</p>
                        </div>
                        {% endif %}
                        {% if appraisal.self_challenges %}
                        <div class="mb-3">
                            <h5>Khó khăn gặp phải</h5>
                            <p>{{ appraisal.self_challenges }}</p>
                        </div>
                        {% endif %}
                        {% if appraisal.self_goals %}
                        <div class="mb-3">
                            <h5>Mục tiêu kỳ tiếp theo</h5>
                            <p>{{ appraisal.self_goals }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Manager Review -->
                {% if appraisal.manager_review %}
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">Đánh giá của quản lý</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h5>Nhận xét chung</h5>
                            <p>{{ appraisal.manager_review }}</p>
                        </div>
                        {% if appraisal.manager_strengths %}
                        <div class="mb-3">
                            <h5>Điểm mạnh</h5>
                            <p>{{ appraisal.manager_strengths }}</p>
                        </div>
                        {% endif %}
                        {% if appraisal.manager_weaknesses %}
                        <div class="mb-3">
                            <h5>Điểm cần cải thiện</h5>
                            <p>{{ appraisal.manager_weaknesses }}</p>
                        </div>
                        {% endif %}
                        {% if appraisal.manager_recommendations %}
                        <div class="mb-3">
                            <h5>Đề xuất phát triển</h5>
                            <p>{{ appraisal.manager_recommendations }}</p>
                        </div>
                        {% endif %}
                        <div class="row">
                            <div class="col-md-6">
                                {% if appraisal.recommend_promotion %}
                                    <div class="alert alert-success">
                                        <i class="fas fa-arrow-up"></i> <strong>Đề xuất thăng chức</strong>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                {% if appraisal.recommend_training %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-graduation-cap"></i> <strong>Đề xuất đào tạo</strong>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- HR Final Review -->
                {% if appraisal.status == 'completed' %}
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title">Đánh giá cuối cùng của HR</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-3">Điểm cuối:</dt>
                            <dd class="col-sm-9">
                                <strong style="font-size: 1.5em;" class="text-success">{{ appraisal.final_score }}</strong>
                            </dd>

                            <dt class="col-sm-3">Xếp loại:</dt>
                            <dd class="col-sm-9">
                                {% if appraisal.overall_rating == 'outstanding' %}
                                    <span class="badge badge-danger badge-lg">Xuất sắc</span>
                                {% elif appraisal.overall_rating == 'exceeds' %}
                                    <span class="badge badge-success badge-lg">Vượt mức</span>
                                {% elif appraisal.overall_rating == 'meets' %}
                                    <span class="badge badge-primary badge-lg">Đạt yêu cầu</span>
                                {% elif appraisal.overall_rating == 'needs_improvement' %}
                                    <span class="badge badge-warning badge-lg">Cần cải thiện</span>
                                {% elif appraisal.overall_rating == 'unsatisfactory' %}
                                    <span class="badge badge-secondary badge-lg">Không đạt</span>
                                {% endif %}
                            </dd>

                            {% if appraisal.salary_adjustment %}
                            <dt class="col-sm-3">Điều chỉnh lương:</dt>
                            <dd class="col-sm-9">
                                <strong class="text-success">+{{ appraisal.salary_adjustment|floatformat:0 }} VNĐ</strong>
                            </dd>
                            {% endif %}

                            {% if appraisal.hr_comments %}
                            <dt class="col-sm-3">Nhận xét HR:</dt>
                            <dd class="col-sm-9">{{ appraisal.hr_comments }}</dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>
                {% endif %}

                <!-- Comments -->
                {% if comments %}
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Thảo luận</h3>
                    </div>
                    <div class="card-body">
                        {% for comment in comments %}
                        <div class="direct-chat-msg {% if comment.author == appraisal.employee %}right{% endif %}">
                            <div class="direct-chat-infos clearfix">
                                <span class="direct-chat-name {% if comment.author == appraisal.employee %}float-right{% else %}float-left{% endif %}">
                                    {{ comment.author.name }}
                                </span>
                                <span class="direct-chat-timestamp {% if comment.author == appraisal.employee %}float-left{% else %}float-right{% endif %}">
                                    {{ comment.created_at|date:"d/m/Y H:i" }}
                                </span>
                            </div>
                            <div class="direct-chat-text">
                                {{ comment.comment }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="card">
                    <div class="card-body">
                        <a href="javascript:history.back()" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                        <button onclick="window.print()" class="btn btn-info">
                            <i class="fas fa-print"></i> In đánh giá
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock main_content %}

{% block custom_css %}
<style>
@media print {
    .content-header, .card-tools, .btn, .breadcrumb { display: none !important; }
}
</style>
{% endblock custom_css %}
