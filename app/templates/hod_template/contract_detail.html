{% extends 'hod_template/base_template.html' %}
{% load static %}
{% load permission_tags %}

{% block page_title %}
Chi tiết Hợp đồng {{ contract.contract_code }}
{% endblock page_title %}

{% block main_content %}
<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-file-contract"></i> Chi tiết Hợp đồng</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'manage_contracts' %}">Hợp đồng</a></li>
                    <li class="breadcrumb-item active">{{ contract.contract_code }}</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- Action Buttons -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="btn-group">
                    <a href="{% url 'manage_contracts' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>
                    {% if user|has_group:'HR' %}
                        {% if contract.status == 'draft' or contract.status == 'active' %}
                        <a href="{% url 'edit_contract' contract.id %}" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Sửa hợp đồng
                        </a>
                        {% endif %}
                        {% if contract.status == 'active' and contract.end_date %}
                        <button type="button" class="btn btn-info" data-toggle="modal" data-target="#renewModal">
                            <i class="fas fa-redo"></i> Gia hạn hợp đồng
                        </button>
                        {% endif %}
                        {% if contract.status == 'draft' %}
                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal">
                            <i class="fas fa-trash"></i> Xóa hợp đồng
                        </button>
                        {% endif %}
                    {% endif %}
                    {% if contract.attachment %}
                    <a href="{{ contract.attachment.url }}" class="btn btn-success" target="_blank">
                        <i class="fas fa-download"></i> Tải file HĐ
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Alert if expiring soon -->
        {% if contract.is_expiring_soon %}
        <div class="alert alert-warning alert-dismissible">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <h5><i class="icon fas fa-exclamation-triangle"></i> Cảnh báo!</h5>
            Hợp đồng này sẽ hết hạn sau <strong>{{ contract.days_until_expiry }} ngày</strong> ({{ contract.end_date|date:"d/m/Y" }}).
            Vui lòng xem xét gia hạn hoặc chấm dứt hợp đồng.
        </div>
        {% endif %}

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
                
                <!-- Basic Information -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Mã hợp đồng:</dt>
                            <dd class="col-sm-8"><strong>{{ contract.contract_code }}</strong></dd>
                            
                            <dt class="col-sm-4">Loại hợp đồng:</dt>
                            <dd class="col-sm-8">{{ contract.get_contract_type_display }}</dd>
                            
                            <dt class="col-sm-4">Trạng thái:</dt>
                            <dd class="col-sm-8">
                                {% if contract.status == 'draft' %}
                                    <span class="badge badge-secondary">Nháp</span>
                                {% elif contract.status == 'active' %}
                                    <span class="badge badge-success">Đang hiệu lực</span>
                                {% elif contract.status == 'expired' %}
                                    <span class="badge badge-warning">Hết hạn</span>
                                {% elif contract.status == 'terminated' %}
                                    <span class="badge badge-danger">Đã chấm dứt</span>
                                {% elif contract.status == 'renewed' %}
                                    <span class="badge badge-info">Đã gia hạn</span>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Ngày ký:</dt>
                            <dd class="col-sm-8">{{ contract.signed_date|date:"d/m/Y"|default:"Chưa ký" }}</dd>
                            
                            <dt class="col-sm-4">Ngày bắt đầu:</dt>
                            <dd class="col-sm-8">{{ contract.start_date|date:"d/m/Y" }}</dd>
                            
                            <dt class="col-sm-4">Ngày kết thúc:</dt>
                            <dd class="col-sm-8">
                                {% if contract.end_date %}
                                    {{ contract.end_date|date:"d/m/Y" }}
                                    {% if contract.is_active %}
                                        <br><small class="text-muted">(Còn {{ contract.days_until_expiry }} ngày)</small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-info">Không xác định</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Employee Information -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-user"></i> Thông tin nhân viên</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Mã NV:</dt>
                            <dd class="col-sm-8">{{ contract.employee.employee_code }}</dd>
                            
                            <dt class="col-sm-4">Tên NV:</dt>
                            <dd class="col-sm-8"><strong>{{ contract.employee.name }}</strong></dd>
                            
                            <dt class="col-sm-4">Email:</dt>
                            <dd class="col-sm-8">{{ contract.employee.email }}</dd>
                            
                            <dt class="col-sm-4">Điện thoại:</dt>
                            <dd class="col-sm-8">{{ contract.employee.phone }}</dd>
                            
                            <dt class="col-sm-4">Phòng ban:</dt>
                            <dd class="col-sm-8">{{ contract.employee.department.name|default:"N/A" }}</dd>
                        </dl>
                    </div>
                </div>

                <!-- Financial Information -->
                <div class="card card-success">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-dollar-sign"></i> Thông tin lương</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Lương cơ bản:</dt>
                            <dd class="col-sm-8"><strong>{{ contract.base_salary|floatformat:0 }} VNĐ</strong></dd>
                            
                            <dt class="col-sm-4">Phụ cấp:</dt>
                            <dd class="col-sm-8">
                                {% if contract.allowances %}
                                    <ul class="list-unstyled mb-0">
                                    {% for key, value in contract.allowances.items %}
                                        <li>{{ key }}: {{ value|floatformat:0 }} VNĐ</li>
                                    {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">Không có</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>

            </div>

            <!-- Right Column -->
            <div class="col-md-6">
                
                <!-- Job Information -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-briefcase"></i> Thông tin công việc</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Chức danh:</dt>
                            <dd class="col-sm-8">{{ contract.job_title.name|default:"N/A" }}</dd>
                            
                            <dt class="col-sm-4">Phòng ban:</dt>
                            <dd class="col-sm-8">{{ contract.department.name|default:"N/A" }}</dd>
                            
                            <dt class="col-sm-4">Nơi làm việc:</dt>
                            <dd class="col-sm-8">{{ contract.work_location|default:"Không xác định" }}</dd>
                            
                            <dt class="col-sm-4">Giờ làm việc:</dt>
                            <dd class="col-sm-8">{{ contract.working_hours }}</dd>
                        </dl>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-file-alt"></i> Điều khoản & Ghi chú</h3>
                    </div>
                    <div class="card-body">
                        {% if contract.terms %}
                        <h6><strong>Các điều khoản:</strong></h6>
                        <div class="border p-2 bg-light mb-3">
                            {{ contract.terms|linebreaks }}
                        </div>
                        {% endif %}
                        
                        {% if contract.notes %}
                        <h6><strong>Ghi chú:</strong></h6>
                        <div class="border p-2 bg-light">
                            {{ contract.notes|linebreaks }}
                        </div>
                        {% endif %}
                        
                        {% if not contract.terms and not contract.notes %}
                        <p class="text-muted">Không có thông tin</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Metadata -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-info"></i> Metadata</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Người tạo:</dt>
                            <dd class="col-sm-8">{{ contract.created_by.name|default:"N/A" }}</dd>
                            
                            <dt class="col-sm-4">Ngày tạo:</dt>
                            <dd class="col-sm-8">{{ contract.created_at|date:"d/m/Y H:i" }}</dd>
                            
                            <dt class="col-sm-4">Cập nhật:</dt>
                            <dd class="col-sm-8">{{ contract.updated_at|date:"d/m/Y H:i" }}</dd>
                        </dl>
                    </div>
                </div>

            </div>
        </div>

        <!-- Renewal History -->
        {% if contract.renewed_from or renewals %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> Lịch sử gia hạn</h3>
                    </div>
                    <div class="card-body">
                        {% if contract.renewed_from %}
                        <div class="alert alert-info">
                            <strong>Hợp đồng này được gia hạn từ:</strong>
                            <a href="{% url 'contract_detail' contract.renewed_from.id %}" class="alert-link">
                                {{ contract.renewed_from.contract_code }}
                            </a>
                            ({{ contract.renewed_from.start_date|date:"d/m/Y" }} - {{ contract.renewed_from.end_date|date:"d/m/Y" }})
                        </div>
                        {% endif %}
                        
                        {% if renewals %}
                        <h6><strong>Các hợp đồng gia hạn từ hợp đồng này:</strong></h6>
                        <ul class="list-group">
                            {% for renewal in renewals %}
                            <li class="list-group-item">
                                <a href="{% url 'contract_detail' renewal.id %}">{{ renewal.contract_code }}</a>
                                - {{ renewal.get_contract_type_display }}
                                ({{ renewal.start_date|date:"d/m/Y" }} - {% if renewal.end_date %}{{ renewal.end_date|date:"d/m/Y" }}{% else %}Vô thời hạn{% endif %})
                                <span class="badge badge-{% if renewal.status == 'active' %}success{% else %}secondary{% endif %} float-right">
                                    {{ renewal.get_status_display }}
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Contract History Timeline -->
        {% if history %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-clock"></i> Lịch sử thay đổi</h3>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for h in history %}
                            <div>
                                <i class="fas fa-{% if h.action == 'created' %}plus{% elif h.action == 'renewed' %}redo{% elif h.action == 'salary_adjusted' %}dollar-sign{% elif h.action == 'terminated' %}ban{% else %}edit{% endif %} bg-{% if h.action == 'created' %}success{% elif h.action == 'renewed' %}info{% elif h.action == 'salary_adjusted' %}warning{% elif h.action == 'terminated' %}danger{% else %}primary{% endif %}"></i>
                                <div class="timeline-item">
                                    <span class="time"><i class="fas fa-clock"></i> {{ h.performed_at|date:"d/m/Y H:i" }}</span>
                                    <h3 class="timeline-header">
                                        <strong>{{ h.get_action_display }}</strong>
                                        {% if h.performed_by %}
                                        - bởi {{ h.performed_by.name }}
                                        {% endif %}
                                    </h3>
                                    <div class="timeline-body">
                                        {{ h.description }}
                                        {% if h.old_value or h.new_value %}
                                        <div class="mt-2">
                                            {% if h.old_value %}
                                            <small class="text-muted">
                                                <strong>Trước:</strong> 
                                                {% for key, value in h.old_value.items %}
                                                    {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            </small>
                                            <br>
                                            {% endif %}
                                            {% if h.new_value %}
                                            <small class="text-success">
                                                <strong>Sau:</strong> 
                                                {% for key, value in h.new_value.items %}
                                                    {{ key }}: {{ value }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            </small>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <div>
                                <i class="fas fa-clock bg-gray"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</section>

<!-- Renew Contract Modal -->
<div class="modal fade" id="renewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form method="post" action="{% url 'renew_contract' contract.id %}">
                {% csrf_token %}
                <div class="modal-header bg-info">
                    <h5 class="modal-title">Gia hạn hợp đồng</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Tạo hợp đồng mới gia hạn từ <strong>{{ contract.contract_code }}</strong></p>
                    
                    <div class="form-group">
                        <label>Ngày bắt đầu: <span class="text-danger">*</span></label>
                        <input type="date" name="new_start_date" class="form-control" required 
                               value="{{ contract.end_date|date:'Y-m-d' }}">
                        <small class="text-muted">Thường là ngày kết thúc HĐ cũ hoặc ngày kế tiếp</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Ngày kết thúc:</label>
                        <input type="date" name="new_end_date" class="form-control">
                        <small class="text-muted">Để trống nếu không xác định thời hạn</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-info">Xác nhận gia hạn</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Contract Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form method="post" action="{% url 'delete_contract' contract.id %}">
                {% csrf_token %}
                <div class="modal-header bg-danger">
                    <h5 class="modal-title">Xóa hợp đồng</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa hợp đồng <strong>{{ contract.contract_code }}</strong>?</p>
                    <p class="text-danger"><strong>Lưu ý:</strong> Chỉ có thể xóa hợp đồng ở trạng thái nháp!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-danger">Xác nhận xóa</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock main_content %}
