{% extends 'hod_template/base_template.html' %}
{% load humanize %}
{% block page_title %}
Tính Lương
{% endblock page_title %}
{% block main_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Tính Lương</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Nhân viên</label>
                                    <select class="form-control" id="employee">
                                        {% for employee in employees %}
                                        <option value="{{ employee.id }}">{{ employee.name }} ({{ employee.employee_code }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Tháng</label>
                                    <select class="form-control" id="month">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Năm</label>
                                    <select class="form-control" id="year">
                                        {% for year in years %}
                                        <option value="{{ year }}">{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary btn-block" id="calculate">Tính Lương</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Bảng Tính Lương</h3>
                    </div>
                    <div class="card-body">
                        <form role="form" action="{% url 'save_payroll' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="employee_id" id="hidden_employee_id">
                            <input type="hidden" name="month" id="hidden_month">
                            <input type="hidden" name="year" id="hidden_year">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Lương cơ bản</label>
                                        <input type="text" name="base_salary" class="form-control base-salary" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Hệ số lương</label>
                                        <input type="text" name="salary_coefficient" class="form-control salary-coefficient" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Lương theo giờ</label>
                                        <input type="number" name="hourly_rate" class="form-control hourly-rate" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Tổng số giờ làm việc</label>
                                        <input type="text" name="total_working_hours" class="form-control total-hours" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Thưởng</label>
                                        <input type="text" name="bonus" class="form-control bonus" value="0" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Phạt</label>
                                        <input type="number" name="penalty" class="form-control penalty" value="0" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Tổng lương</label>
                                        <input type="text" name="total_salary" class="form-control total-salary" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Ghi chú</label>
                                        <input type="text" name="notes" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">Lưu Bảng Lương</button>
                                <a href="{% url 'manage_payroll' %}" class="btn btn-secondary">Trở Về</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock main_content %}
{% block custom_js %}
<script>
    // Global format function for thousand separator
    function formatNumber(num) {
        if (!num && num !== 0) return '';
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    function unformatNumber(str) {
        return parseFloat(str.replace(/,/g, '')) || 0;
    }

    $(document).ready(function() {
        // Lấy danh sách năm từ năm hiện tại trở về trước 5 năm
        var currentYear = new Date().getFullYear();
        var years = [];
        for(var i = currentYear; i >= currentYear - 5; i--) {
            years.push(i);
        }
        $("#year").html(years.map(year => `<option value="${year}">${year}</option>`).join(''));

        // If edit mode, populate form with existing payroll data
        {% if edit_mode and payroll %}
        $("#employee").val({{ payroll.employee.id }});
        $("#month").val({{ payroll.month }});
        $("#year").val({{ payroll.year }});
        $("#hidden_employee_id").val({{ payroll.employee.id }});
        $("#hidden_month").val({{ payroll.month }});
        $("#hidden_year").val({{ payroll.year }});
        $(".base-salary").val({{ payroll.base_salary }});
        $(".salary-coefficient").val({{ payroll.salary_coefficient }});
        $(".hourly-rate").val({{ payroll.hourly_rate }});
        $(".total-hours").val({{ payroll.total_working_hours }});
        $(".bonus").val({{ payroll.bonus }});
        $(".penalty").val({{ payroll.penalty }});
        $(".total-salary").val({{ payroll.total_salary }});
        $("input[name='notes']").val("{{ payroll.notes|default:'' }}");
        {% endif %}

        // Tự động tính lại tổng lương khi thay đổi thưởng/phạt
        $(".bonus, .penalty").change(function() {
            var hourlyRate = parseFloat($(".hourly-rate").val().replace(/[^\d.-]/g, '')) || 0;
            var totalHours = parseFloat($(".total-hours").val()) || 0;
            var bonus = parseFloat($(".bonus").val()) || 0;
            var penalty = parseFloat($(".penalty").val()) || 0;

            var totalSalary = Math.round((hourlyRate * totalHours) + bonus - penalty);
            $(".total-salary").val(totalSalary);
        });

        // Xử lý khi bấm nút Tính Lương
        $("#calculate").click(function() {
            var employeeId = $("#employee").val();
            var month = $("#month").val();
            var year = $("#year").val();
            $("#hidden_employee_id").val(employeeId);
            $("#hidden_month").val(month);
            $("#hidden_year").val(year);

            // Gọi API để lấy dữ liệu
            $.ajax({
                url: "{% url 'get_payroll_data' %}",
                type: "POST",
                data: {
                    employee_id: employeeId,
                    month: month,
                    year: year,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function(response) {
                    if(response.status == "success") {
                        // Cập nhật dữ liệu với format
                        $(".base-salary").val(formatNumber(response.data.base_salary));
                        $(".salary-coefficient").val(response.data.salary_coefficient);
                        $(".hourly-rate").val(formatNumber(response.data.hourly_rate));
                        $(".total-hours").val(response.data.total_working_hours);
                        $(".bonus").val(formatNumber(response.data.bonus));
                        $(".penalty").val(formatNumber(response.data.penalty));
                        $(".total-salary").val(formatNumber(response.data.total_salary));
                        $("input[name='notes']").val(response.data.notes);
                    } else {
                        alert(response.message || "Có lỗi xảy ra khi tính lương");
                    }
                }
            });
        });

        // Auto-format number fields on blur
        $(".base-salary, .hourly-rate, .bonus, .penalty").on('blur', function() {
            var value = unformatNumber($(this).val());
            $(this).val(formatNumber(value));
            
            // Recalculate total if needed
            var hourlyRate = unformatNumber($(".hourly-rate").val()) || 0;
            var totalHours = parseFloat($(".total-hours").val()) || 0;
            var bonus = unformatNumber($(".bonus").val()) || 0;
            var penalty = unformatNumber($(".penalty").val()) || 0;
            var totalSalary = Math.round((hourlyRate * totalHours) + bonus - penalty);
            $(".total-salary").val(formatNumber(totalSalary));
        });
        
        // Xử lý khi form được submit
        $("form").submit(function(e) {
            e.preventDefault();
            
            // Lấy giá trị từ các trường input (remove commas)
            var baseSalary = unformatNumber($(".base-salary").val()) || 0;
            var hourlyRate = unformatNumber($(".hourly-rate").val()) || 0;
            var totalHours = parseFloat($(".total-hours").val()) || 0;
            var bonus = unformatNumber($(".bonus").val()) || 0;
            var penalty = unformatNumber($(".penalty").val()) || 0;
            var totalSalary = Math.round((hourlyRate * totalHours) + bonus - penalty);

            // Cập nhật giá trị trước khi submit
            $("input[name='base_salary']").val(baseSalary);
            $("input[name='hourly_rate']").val(hourlyRate);
            $("input[name='total_salary']").val(totalSalary);

            // Submit form
            this.submit();
        });
    });
</script>
{% endblock custom_js %} 