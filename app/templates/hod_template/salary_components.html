{% extends 'hod_template/base_template.html' %}

{% block page_title %}
Thành phần lương
{% endblock page_title %}

{% block content %}

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">Thành phần lương</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Trang chủ</a></li>
            <li class="breadcrumb-item active">Thành phần lương</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      
      <!-- Statistics Cards -->
      <div class="row mb-3">
        <div class="col-lg-4 col-6">
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ components.count }}</h3>
              <p>Tổng thành phần</p>
            </div>
            <div class="icon">
              <i class="fas fa-list"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3>{{ active_count }}</h3>
              <p>Đang hoạt động</p>
            </div>
            <div class="icon">
              <i class="fas fa-check-circle"></i>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-6">
          <div class="small-box bg-warning">
            <div class="inner">
              <h3>{{ mandatory_count }}</h3>
              <p>Bắt buộc</p>
            </div>
            <div class="icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="row mb-3">
        <div class="col-12">
          <a href="{% url 'create_salary_component' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Thêm thành phần mới
          </a>
          <a href="{% url 'bulk_assign_salary_rules' %}" class="btn btn-success">
            <i class="fas fa-users"></i> Gán hàng loạt
          </a>
        </div>
      </div>

      <!-- Components Table -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Danh sách thành phần lương</h3>
          <div class="card-tools">
            <div class="input-group input-group-sm" style="width: 250px;">
              <input type="text" id="searchInput" class="form-control float-right" placeholder="Tìm kiếm...">
              <div class="input-group-append">
                <button type="submit" class="btn btn-default">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body table-responsive p-0">
          <table class="table table-hover text-nowrap" id="componentsTable">
            <thead>
              <tr>
                <th>Mã</th>
                <th>Tên</th>
                <th>Loại</th>
                <th>Phương thức tính</th>
                <th>Giá trị</th>
                <th>Tính thuế</th>
                <th>Bắt buộc</th>
                <th>Trạng thái</th>
                <th style="width: 200px;">Thao tác</th>
              </tr>
            </thead>
            <tbody>
              {% for component in components %}
              <tr>
                <td><code>{{ component.code }}</code></td>
                <td><strong>{{ component.name }}</strong></td>
                <td>
                  {% if component.component_type == 'allowance' %}
                    <span class="badge badge-info">{{ component.get_component_type_display }}</span>
                  {% elif component.component_type == 'bonus' %}
                    <span class="badge badge-success">{{ component.get_component_type_display }}</span>
                  {% elif component.component_type == 'deduction' %}
                    <span class="badge badge-danger">{{ component.get_component_type_display }}</span>
                  {% else %}
                    <span class="badge badge-warning">{{ component.get_component_type_display }}</span>
                  {% endif %}
                </td>
                <td>{{ component.get_calculation_method_display }}</td>
                <td>
                  {% if component.calculation_method == 'fixed' %}
                    {{ component.default_amount|floatformat:0 }} VNĐ
                  {% elif component.calculation_method == 'percentage' %}
                    {{ component.percentage }}%
                  {% elif component.calculation_method == 'formula' %}
                    <span class="text-muted" title="{{ component.formula }}">
                      <i class="fas fa-calculator"></i> Formula
                    </span>
                  {% else %}
                    {{ component.default_amount|floatformat:0 }} VNĐ
                  {% endif %}
                </td>
                <td>
                  {% if component.is_taxable %}
                    <i class="fas fa-check text-success"></i>
                  {% else %}
                    <i class="fas fa-times text-danger"></i>
                  {% endif %}
                </td>
                <td>
                  {% if component.is_mandatory %}
                    <span class="badge badge-warning">Bắt buộc</span>
                  {% else %}
                    <span class="badge badge-secondary">Tùy chọn</span>
                  {% endif %}
                </td>
                <td>
                  {% if component.is_active %}
                    <span class="badge badge-success">Hoạt động</span>
                  {% else %}
                    <span class="badge badge-secondary">Vô hiệu</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="{% url 'edit_salary_component' component.id %}" class="btn btn-info" title="Chỉnh sửa">
                      <i class="fas fa-edit"></i>
                    </a>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete({{ component.id }}, '{{ component.name }}')" title="Xóa">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted">
                  <i class="fas fa-inbox fa-3x mb-3"></i>
                  <p>Chưa có thành phần lương nào</p>
                  <a href="{% url 'create_salary_component' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Tạo thành phần đầu tiên
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </section>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title">Xác nhận xóa</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa thành phần <strong id="componentName"></strong>?</p>
        <p class="text-muted">Hành động này sẽ vô hiệu hóa thành phần (không xóa vĩnh viễn).</p>
      </div>
      <div class="modal-footer">
        <form id="deleteForm" method="POST">
          {% csrf_token %}
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-danger">Xóa</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Search functionality
$('#searchInput').on('keyup', function() {
  var value = $(this).val().toLowerCase();
  $('#componentsTable tbody tr').filter(function() {
    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
  });
});

// Delete confirmation
function confirmDelete(componentId, componentName) {
  $('#componentName').text(componentName);
  $('#deleteForm').attr('action', '/salary-rules/components/' + componentId + '/delete/');
  $('#deleteModal').modal('show');
}
</script>

{% endblock content %}
